# Trading-HedgeStack v0.2 API Contract (GA Hardening)

This document freezes the v0.2 API semantics for gradual-compat mode.

## Global Rules

1. API prefix remains `/v1`.
2. `account_id` remains optional for v0.2 input payloads unless stated otherwise.
3. If omitted, `account_id` defaults to `main` or is derived from the bound VP.
4. All response entities include `account_id`.
5. Error codes are stable and machine-readable.

## Accounts

### `GET /v1/accounts`

Returns account list from config with runtime stream health:

- `id`, `name`, `type`, `testnet`, `enabled`
- `ws_status`: `CONNECTED | DISCONNECTED | UNKNOWN`
- `last_error`: `string | null`
- `last_connected_at`: `number | null` (unix ms)

## State

### `GET /v1/state?account_id=&symbol=`

- `account_id` optional
- `symbol` optional
- if omitted, returns merged view across accounts/symbols

Response:

- `external_positions[]`
- `virtual_positions[]`
- `open_orders[]`
- `recent_fills[]`
- `market`
- `accounts_status[]`
- `consistency[]`
- `reconcile`

## Trading APIs

### `POST /v1/virtual-positions`

- `account_id` optional, defaults to `main`.

### `POST /v1/orders`

- `account_id` optional.
- Resolution order:
  1. request `account_id`
  2. VP-bound `account_id`
  3. fallback `main`
- Rejects with `VP_DOMAIN_MISMATCH` when request symbol/side mismatches VP domain.
- Rejects with `ACCOUNT_SCOPE_MISMATCH` when explicit `account_id` conflicts with VP account.

### `POST /v1/orders/:orderId/cancel`

- `symbol` required.
- `account_id` optional only when local order mapping exists.
- If mapping missing and no `account_id`, returns:
  - `400 ACCOUNT_ID_REQUIRED_FOR_CANCEL`
- If provided `account_id` conflicts with mapped order account:
  - `400 ACCOUNT_SCOPE_MISMATCH`

### `POST /v1/virtual-positions/:id/close`

- `account_id` optional; when provided must match VP account.
- mismatch => `400 ACCOUNT_SCOPE_MISMATCH`.

### `POST /v1/virtual-positions/:id/tpsl`

- `account_id` optional; when provided must match VP account.
- mismatch => `400 ACCOUNT_SCOPE_MISMATCH`.

### `POST /v1/reconcile`

- `account_id` optional, defaults `main`.
- assignment account/symbol/side mismatch => `400 ACCOUNT_SCOPE_MISMATCH`.
- over assignment => `400 RECONCILE_OVER_ASSIGNED`.

## WebSocket Events

Endpoint: `/ws`

### Added in GA Hardening

- `ACCOUNT_STREAM_STATUS`
  - payload:
    - `account_id`
    - `ws_status`
    - `reason`
    - `last_error`
    - `last_connected_at`
    - `updated_at`

### Existing

- `STATE_SNAPSHOT`
- `ORDER_UPSERT`
- `FILL`
- `VIRTUAL_POSITION_UPDATE`
- `EXTERNAL_POSITION_UPDATE`
- `TPSL_SYNC_STATUS`
- `CONSISTENCY_STATUS`
- `MARKET_TICK`
- `WS_RECONNECT`

## Stable Error Codes

- `INVALID_REQUEST`
- `INVALID_ACCOUNT`
- `INVALID_VP`
- `VP_DOMAIN_MISMATCH`
- `ACCOUNT_SCOPE_MISMATCH`
- `ACCOUNT_ID_REQUIRED_FOR_CANCEL`
- `RECONCILE_OVER_ASSIGNED`
- `RECONCILE_ERROR`
- `TPSL_ERROR`
- `BINANCE_ERROR`

## Pre-v0.3 Operational Endpoints

The following endpoints are additive and do not change the existing v0.2 business semantics:

- `GET /v1/ops/metrics?account_id=&window_sec=`
  - Returns account-scoped counters, totals, and threshold alerts.
- `GET /v1/ops/health`
  - Returns startup checks and runtime health (`OK | DEGRADED | FAIL`).
